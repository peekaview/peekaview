<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Bildschirm teilen - Viewer</title>
</head>
<body>
  <h1>Viewer</h1>
  <video id="remoteVideo" autoplay controls></video>
  
  <!-- Socket.IO Client Library -->
  <script src="https://cdn.socket.io/4.4.1/socket.io.min.js"></script>
  <!-- Simple-Peer Library -->
  <script src="https://unpkg.com/simple-peer@9.11.1/simplepeer.min.js"></script>
  <script>
    const socket = io('wss://c1.peekaview.de'); // Verwenden Sie die richtige URL
    const room = 'testroom';
    const isPresenter = false;
    const peers = {};
    let presenter_id = null;

    socket.on('connect', () => {
      socket.emit('join', { roomId: room, isPresenter: isPresenter });
      console.log('Verbunden mit dem Server und dem Raum beigetreten:', room);
    });

    // Empfang der presenter_id vom Server
    socket.on('presenterId', (id) => {
      presenter_id = id;
      if (presenter_id) {
        console.log('Presenter ID erhalten:', presenter_id);
        addPeer(presenter_id, false);
        socket.emit('initSend', presenter_id);
      } else {
        console.log('Kein Presenter im Raum.');
      }
    });

    socket.on('signal', (data) => {
      if (data.socket_id === presenter_id && peers[presenter_id]) {
        peers[presenter_id].signal(data.signal);
      }
    });

    socket.on('disconnect', () => {
      if (peers[presenter_id]) {
        peers[presenter_id].destroy();
        delete peers[presenter_id];
      }
    });

    function addPeer(socket_id, initiator) {
      peers[socket_id] = new SimplePeer({
        initiator: initiator,
        trickle: false,
        stream: false,
        config: {
          iceServers: [
            { urls: 'stun:stun.l.google.com:19302' }
            // Hier können Sie einen TURN-Server hinzufügen
          ]
        }
      });

      peers[socket_id].on('signal', (data) => {
        socket.emit('signal', {
          signal: data,
          socket_id: socket_id
        });
      });

      peers[socket_id].on('stream', (stream) => {
        console.log('Stream erhalten von', socket_id);
        const remoteVideo = document.getElementById('remoteVideo');
        remoteVideo.srcObject = stream;
      });

      peers[socket_id].on('close', () => {
        console.log('Verbindung zu', socket_id, 'geschlossen');
        delete peers[socket_id];
      });
    }
  </script>
</body>
</html>
