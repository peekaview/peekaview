<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Bildschirm teilen - Presenter</title>
</head>
<body>
  <h1>Presenter</h1>
  <video id="localVideo" autoplay muted style="display: none;"></video>
  <!-- Da der Presenter seinen eigenen Stream nicht sehen muss, ist das Video ausgeblendet -->
  
  <!-- Socket.IO Client Library -->
  <script src="https://cdn.socket.io/4.4.1/socket.io.min.js"></script>
  <!-- Simple-Peer Library -->
  <script src="https://unpkg.com/simple-peer@9.11.1/simplepeer.min.js"></script>
  <script>
    const socket = io('wss://c1.peekaview.de'); // Verwenden Sie die richtige URL
    const room = 'testroom';
    const isPresenter = true;
    const peers = {};
    let localStream;

    socket.on('connect', () => {
      socket.emit('join', { roomId: room, isPresenter: isPresenter });
      console.log('Verbunden mit dem Server und dem Raum beigetreten:', room);
    });

    socket.on('initReceive', (socket_id) => {
      console.log('initReceive von', socket_id);
      addPeer(socket_id, true);
    });

    socket.on('signal', (data) => {
      if (peers[data.socket_id]) {
        peers[data.socket_id].signal(data.signal);
      }
    });

    socket.on('disconnect', () => {
      for (let socket_id in peers) {
        peers[socket_id].destroy();
      }
    });

    function addPeer(socket_id, initiator) {
      peers[socket_id] = new SimplePeer({
        initiator: initiator,
        trickle: false,
        stream: localStream,
        config: {
          iceServers: [
            { urls: 'stun:stun.l.google.com:19302' }
            // Hier können Sie einen TURN-Server hinzufügen
          ]
        }
      });

      peers[socket_id].on('signal', (data) => {
        socket.emit('signal', {
          signal: data,
          socket_id: socket_id
        });
      });

      peers[socket_id].on('close', () => {
        console.log('Verbindung zu', socket_id, 'geschlossen');
        delete peers[socket_id];
      });
    }

    // Bildschirm teilen und Stream erfassen
    navigator.mediaDevices.getDisplayMedia({ video: true, audio: false })
      .then(stream => {
        localStream = stream;
        const localVideo = document.getElementById('localVideo');
        localVideo.srcObject = stream;

        // Optionale Handhabung von Beenden des Screen Sharings
        stream.getVideoTracks()[0].addEventListener('ended', () => {
          console.log('Bildschirmfreigabe beendet');
          // Hier können Sie alle Verbindungen schließen oder den Teilnehmern mitteilen
          for (let socket_id in peers) {
            peers[socket_id].destroy();
          }
        });
      })
      .catch(error => {
        console.error('Fehler beim Teilen des Bildschirms:', error);
      });
  </script>
</body>
</html>
